# Install EKSCTL
curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin
eksctl get cluster
eksctl version

# Install Kubectl
curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
chmod +x ./kubectl
sudo mv ./kubectl /usr/local/bin/kubectl
kubectl version --client

# Install Helm
curl -L https://get.helm.sh/helm-v3.1.2-linux-amd64.tar.gz -o helm.tar.gz
tar xvfz helm.tar.gz linux-amd64/helm
chmod +x ./linux-amd64/helm
sudo mv ./linux-amd64/helm /usr/local/bin
helm version
rm -rf ./linux-amd64
rm helm.tar.gz

# Install fluxctl
curl -s https://fluxcd.io/install.sh | sudo bash
flux -v

# Install weavegitops
curl -L https://github.com/weaveworks/weave-gitops/releases/download/v0.2.1/wego-$(uname)-$(uname -m) -o wego
chmod +x wego
sudo mv ./wego /usr/local/bin/wego
wego version

# Install kustomize
curl --silent --location --remote-name \
"https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v3.2.3/kustomize_kustomize.v3.2.3_linux_amd64" && \
chmod a+x kustomize_kustomize.v3.2.3_linux_amd64 && \
sudo mv kustomize_kustomize.v3.2.3_linux_amd64 /usr/local/bin/kustomize
kustomize version

# Install IAM authenticator
curl -o aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.15.10/2020-02-22/bin/linux/amd64/aws-iam-authenticator
chmod +x ./aws-iam-authenticator
sudo mv ./aws-iam-authenticator /usr/local/bin
aws-iam-authenticator help


#export GithubToken 
echo "export GITHUB_TOKEN=ghp_wBMFXLvczFysFizHFXhTDzXHJAAxuT1ic0Jl" > ~/github.env

# Craete ~/workshop-cluster.yaml

source ~/github.env

# Create a EKS cluster
eksctl create cluster -f ~/workshop-cluster.yaml

# If the deployment fails with below error then do the following 
âœ— Kubernetes API call failed: Get "https://752C98BEC3E76D7074AAF4E9516DFBBD.gr7.us-east-1.eks.amazonaws.com/version": getting credentials: decoding stdout: no kind "ExecCredential" is registered for version "client.authentication.k8s.io/v1alpha1" in scheme "pkg/runtime/scheme.go:100"
# Error: running Flux pre-flight checks: exit status 1
eksctl enable flux --config-file ./fluxconfig.yaml

# Below method works this will bootstrap the flux and create a github repo
flux bootstrap github --owner=ananddeshpande1985 --repository=aws-workshop-module1 --branch=main --path=clusters/aws-workshop-cluster --namespace=flux-system --read-write-key=true --private=false --personal=true --token-auth false --token 

flux bootstrap github --owner=ananddeshpande1985 --repository=aws-workshop-module2 --branch=main --path=clusters/aws-workshop-cluster --namespace=flux-system --read-write-key=true --private=false --personal=true 


aws eks update-kubeconfig --region us-east-1 --name aws-workshop-cluster

eksctl utils write-kubeconfig --region us-east-1 --cluster aws-workshop-cluster

# Install Git first 
sudo yum update -y
sudo yum install git -y
git â€” version

# Clone the Repo  you creates with flux
git clone git@github.com:ananddeshpande1985/aws-workshop-module2.git

# The folowing command will store the ssh key generated by flux in your ssh keystore
mkdir -p ~/.ssh
kubectl get secret flux-system -n flux-system --template={{.data.identity}} | base64 -d > ~/.ssh/id_rsa
~/.ssh/id_rsa

